name: Playwright Weekly CI Tests (Email Summary)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 8 * * 1"   # Every Monday 8 AM UTC
  push:

jobs:
  run-playwright:
    runs-on: ubuntu-latest
    container: mcr.microsoft.com/playwright:v1.55.0-jammy

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install jq
        run: |
          apt-get update
          apt-get install -y jq

      - name: Run Playwright tests (JSON reporter)
        id: run_tests
        continue-on-error: true
        env:
          BASE_URL: ${{ secrets.BASE_URL }}
        run: |
          mkdir -p reports
          # Run Playwright with both GitHub and JSON reporters, output JSON to ./reports
          npx playwright test tests/smoke --reporter=github,json --output=reports || true

      - name: Generate HTML summary table
        id: mini_report
        run: |
          report_file="reports/test-results.json"
          # fallback to default JSON name if different Playwright version
          if [ ! -f "$report_file" ]; then
            report_file=$(find reports -name "*.json" | head -n 1 || echo "")
          fi

          if [ -z "$report_file" ] || [ ! -s "$report_file" ]; then
            echo "<p>No JSON report found or tests did not run.</p>" > summary.html
            passed=0
            failed=0
            total=0
          else
            echo "<h3>Playwright Test Summary</h3>" > summary.html
            echo "<table border='1' cellpadding='6' cellspacing='0' style='border-collapse:collapse;font-family:Arial,sans-serif;'><tr style='background:#f0f0f0;'><th>Test Name</th><th>Status</th></tr>" >> summary.html

            # Parse all test titles + statuses (supports nested Playwright 1.55 schema)
            jq -r '
              [ .. | objects
                | select(has("title") and has("tests"))
                | {title: .title, status: (.tests[].results[].status // "unknown")}
              ]
              | unique_by(.title)
              | .[]
              | "<tr><td>\(.title)</td><td style=\"color:" + (if .status=="passed" then "green" elif .status=="failed" then "red" else "black" end) + ";\">\(.status)</td></tr>"
            ' "$report_file" >> summary.html || true

            echo "</table>" >> summary.html

            passed=$(jq '[.. | .status?] | map(select(.=="passed")
