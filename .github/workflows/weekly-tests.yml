# This name will appear in the GitHub Actions UI
name: Playwright CI Tests

on:
  # Allows manual runs from the Actions tab
  workflow_dispatch:     
  
  # Runs on a schedule
  schedule:
    - cron: "0 8 * * 1"  # 8:00 AM UTC every Monday
    
  # Runs on a push to any branch
  push:

jobs:
  run-playwright:
    runs-on: ubuntu-latest
    
    container: mcr.microsoft.com/playwright:v1.45.0-jammy

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: 'npm'

      - name: Install dependencies
        run: npm ci


      - name: Run Playwright tests
        id: run_tests 

        continue-on-error: true
        env:

          BASE_URL: https://virufy.org/en/
          CI: true 

        run: npx playwright test tests/weekly --reporter=html,json:test-results.json


      - name: Install jq
        if: always()
        run: |
          apt-get update
          apt-get install -y jq


      - name: Create Test Summary
        if: always()
        id: summary
        run: |
          # Default values in case the file doesn't exist
          PASSED_COUNT=0
          FAILED_COUNT=0
          TOTAL_COUNT=0
          FAILED_LIST="No failed tests."
          PASSED_LIST="No passed tests."
          
          # Check if the JSON file was created
          if [ -f test-results.json ]; then
            # Parse the JSON file to get counts
            PASSED_COUNT=$(jq -r '[.suites[].specs[] | select(.ok == true)] | length' test-results.json)
            FAILED_COUNT=$(jq -r '[.suites[].specs[] | select(.ok == false)] | length' test-results.json)
            TOTAL_COUNT=$((PASSED_COUNT + FAILED_COUNT))

            # Get list of failed test titles, format them with a 'â€¢'
            FAILED_LIST=$(jq -r '.suites[].specs[] | select(.ok == false) | "â€¢ " + .title' test-results.json)
            if [ -z "$FAILED_LIST" ]; then FAILED_LIST="No failed tests."; fi
            
            # Get list of passed test titles
            PASSED_LIST=$(jq -r '.suites[].specs[] | select(.ok == true) | "â€¢ " + .title' test-results.json)
            if [ -z "$PASSED_LIST" ]; then PASSED_LIST="No passed tests."; fi
          fi

          # Save counts for the subject line
          echo "passed_count=$PASSED_COUNT" >> $GITHUB_OUTPUT
          echo "failed_count=$FAILED_COUNT" >> $GITHUB_OUTPUT
          echo "total_count=$TOTAL_COUNT" >> $GITHUB_OUTPUT
          
          # Save the multi-line lists to files to be used in the email body
          echo "$FAILED_LIST" > failed_tests.txt
          echo "$PASSED_LIST" > passed_tests.txt
          
          # Save the main status (success/failure) for the subject line
          if [ $FAILED_COUNT -eq 0 ] && [ $TOTAL_COUNT -gt 0 ]; then
             echo "run_status=âœ…" >> $GITHUB_OUTPUT
          else
             echo "run_status=âŒ" >> $GITHUB_OUTPUT
          fi


      - name: Zip Playwright Report
        if: always()
        # This zips the 'playwright-report' folder into a file named 'playwright-report.zip'
        run: zip -r playwright-report.zip ./playwright-report


      - name: Email test summary
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASS }}
          
          # Subject now uses our parsed counts and status
          subject: "CI Test Report: ${{ steps.summary.outputs.run_status }} ${{ steps.summary.outputs.passed_count }} Passed / ${{ steps.summary.outputs.failed_count }} Failed"
          to: qa1@gmail.com, qa2@gmail.com, qa3@gmail.com
          from: "Playwright CI <${{ secrets.SMTP_USER }}>"
          
          # This tells Gmail to render the body as Markdown (tables, bold, etc.)
          content_type: text/markdown
          
          # Read the summary from our text files
          body: |
            ## Test Run Summary
            
            | Status | Count |
            | :--- | ---: |
            | ðŸŸ¢ Passed | ${{ steps.summary.outputs.passed_count }} |
            | ðŸ”´ Failed | ${{ steps.summary.outputs.failed_count }} |
            | **Total** | **${{ steps.summary.outputs.total_count }}** |
            
            ---
            
            ### ðŸ”´ Failed Tests
            ```
            $(cat failed_tests.txt)
            ```
            
            ---
            
            ### ðŸŸ¢ Passed Tests
            ```
            $(cat passed_tests.txt)
            ```
            
            ---
            The full interactive HTML report is attached as `playwright-report.zip`.
            
            View the full run logs in GitHub:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            

          attachments: playwright-report.zip