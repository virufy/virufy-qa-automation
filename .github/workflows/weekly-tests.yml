name: Playwright Weekly CI Tests (Email Summary)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 8 * * 1"   # Every Monday 8 AM UTC
  push:

jobs:
  run-playwright:
    runs-on: ubuntu-latest
    container: mcr.microsoft.com/playwright:v1.55.0-jammy

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install jq
        run: |
          apt-get update
          apt-get install -y jq

      - name: Run Playwright tests (JSON reporter)
        id: run_tests
        continue-on-error: true
        env:
          BASE_URL: ${{ secrets.BASE_URL }}
        run: |
          mkdir -p reports
          # JSON reporter creates test-results.json in current directory
          npx playwright test tests/smoke --reporter=github,json --output=reports || true
          # Copy JSON report to reports directory if it exists in root
          if [ -f "test-results.json" ]; then
            cp test-results.json reports/test-results.json || true
          fi

      - name: Generate HTML summary table
        id: mini_report
        run: |
          # Find the JSON report file - Playwright JSON reporter creates test-results.json
          report_file=""
          if [ -f "reports/test-results.json" ]; then
            report_file="reports/test-results.json"
          elif [ -f "test-results.json" ]; then
            report_file="test-results.json"
          else
            # Search for any JSON file in reports directory or subdirectories
            report_file=$(find reports -type f -name "*.json" 2>/dev/null | head -n 1 || echo "")
          fi

          if [ -z "$report_file" ] || [ ! -s "$report_file" ]; then
            echo "<p>No JSON report found or tests did not run.</p>" > summary.html
            passed=0
            failed=0
            total=0
          else
            echo "<h3>Playwright Test Summary</h3>" > summary.html
            echo "<table border='1' cellpadding='6' cellspacing='0' style='border-collapse:collapse;font-family:Arial,sans-serif;min-width:400px;'><tr style='background:#f0f0f0;'><th>Test Name</th><th>Status</th></tr>" >> summary.html

            # Extract all test specs with their status - handle nested suites structure
            # Recursively extract all specs from suites
            jq -r '
              def get_all_specs:
                (if .specs then .specs[] else empty end),
                (if .suites then .suites[] | get_all_specs else empty end);
              
              .suites[] | get_all_specs
              | select(.tests != null and (.tests | length) > 0)
              | .tests[0].results[-1].status as $status
              | "<tr style=\"background:" + (if $status=="failed" then "#ffe5e5" else "white" end) + ";\"><td>\(.title)</td><td style=\"color:" + (if $status=="passed" then "green" elif $status=="failed" then "red" else "black" end) + ";font-weight:bold;\">\($status // "unknown")</td></tr>"
            ' "$report_file" >> summary.html 2>/dev/null || true

            echo "</table>" >> summary.html

            # Count passed, failed, and total tests
            # Extract all test statuses recursively using the same function
            passed=$(jq -r '
              def get_all_specs:
                (if .specs then .specs[] else empty end),
                (if .suites then .suites[] | get_all_specs else empty end);
              
              [.suites[] | get_all_specs | select(.tests != null and (.tests | length) > 0) | .tests[0].results[-1].status // "unknown"]
              | map(select(.=="passed"))
              | length
            ' "$report_file" 2>/dev/null || echo "0")
            
            failed=$(jq -r '
              def get_all_specs:
                (if .specs then .specs[] else empty end),
                (if .suites then .suites[] | get_all_specs else empty end);
              
              [.suites[] | get_all_specs | select(.tests != null and (.tests | length) > 0) | .tests[0].results[-1].status // "unknown"]
              | map(select(.=="failed"))
              | length
            ' "$report_file" 2>/dev/null || echo "0")
            
            total=$(jq -r '
              def get_all_specs:
                (if .specs then .specs[] else empty end),
                (if .suites then .suites[] | get_all_specs else empty end);
              
              [.suites[] | get_all_specs | select(.tests != null and (.tests | length) > 0)]
              | length
            ' "$report_file" 2>/dev/null || echo "0")
            
            # Ensure we have numeric values
            passed=${passed:-0}
            failed=${failed:-0}
            total=${total:-0}
          fi

          {
            echo "html<<EOF"
            cat summary.html
            echo "EOF"
            echo "passed=$passed"
            echo "failed=$failed"
            echo "total=$total"
          } >> $GITHUB_OUTPUT

      - name: Send summary email
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASS }}
          subject: "Weekly Playwright CI Report - ${{ steps.mini_report.outputs.passed }} Passed / ${{ steps.mini_report.outputs.failed }} Failed"
          to: ${{ secrets.REPORT_RECIPIENT }}
          from: "Playwright CI <${{ secrets.SMTP_USER }}>"
          html_body: |
            <h3>Playwright CI Test Summary</h3>
            <p>Total: ${{ steps.mini_report.outputs.total }}</p>
            <p>Passed: <span style="color:green;font-weight:bold;">${{ steps.mini_report.outputs.passed }}</span></p>
            <p>Failed: <span style="color:red;font-weight:bold;">${{ steps.mini_report.outputs.failed }}</span></p>
            <br/>
            <p>Detailed test summary:</p>
            ${{ steps.mini_report.outputs.html }}
            <br/>
            <p>Full logs and artifacts:</p>
            <p><a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">View GitHub Actions Run</a></p>
