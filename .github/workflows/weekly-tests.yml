name: Playwright Weekly CI Tests (Email Summary)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 8 * * 1"   # Every Monday 8 AM UTC
  push:

jobs:
  run-playwright:
    runs-on: ubuntu-latest
    container: mcr.microsoft.com/playwright:v1.55.0-jammy

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run Playwright tests
        id: run_tests
        continue-on-error: true
        env:
          BASE_URL: ${{ secrets.BASE_URL }}
        run: npx playwright test --reporter=html || true

      - name: Parse HTML report summary
        id: parse_results
        run: |
          node - <<'EOF'
          import fs from 'fs';
          let passed=0, failed=0, total=0;
          const file='playwright-report/data.json';
          if (fs.existsSync(file)) {
            const data=JSON.parse(fs.readFileSync(file,'utf8'));
            const count=(s)=>{
              s.specs?.forEach(sp=>{
                const st=sp.tests?.[0]?.results?.at(-1)?.status;
                if(st){total++; if(st==='passed')passed++; if(st==='failed')failed++;}
              });
              s.suites?.forEach(count);
            };
            data.suites?.forEach(count);
          } else {
            console.log('No report data.json found');
          }
          console.log(`Total: ${total}, Passed: ${passed}, Failed: ${failed}`);
          console.log(`passed=${passed}`);
          console.log(`failed=${failed}`);
          console.log(`total=${total}`);
          fs.appendFileSync(process.env.GITHUB_OUTPUT,`passed=${passed}\nfailed=${failed}\ntotal=${total}\n`);
          EOF
        outputs:
          passed: ${{ steps.parse_results.outputs.passed }}
          failed: ${{ steps.parse_results.outputs.failed }}
          total: ${{ steps.parse_results.outputs.total }}

      - name: Send summary email
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASS }}
          subject: "Playwright CI Report - ${{ steps.parse_results.outputs.passed }} Passed / ${{ steps.parse_results.outputs.failed }} Failed"
          to: ${{ secrets.REPORT_RECIPIENT }}
          from: "Playwright CI <${{ secrets.SMTP_USER }}>"
          html_body: |
            <h3>Playwright Test Results</h3>
            <table border="1" cellpadding="10" style="border-collapse:collapse;font-family:Arial,sans-serif;">
              <tr><th>Metric</th><th>Count</th></tr>
              <tr><td><b>Total</b></td><td>${{ steps.parse_results.outputs.total }}</td></tr>
              <tr><td><b>Passed</b></td><td style="color:green;"><b>${{ steps.parse_results.outputs.passed }}</b></td></tr>
              <tr><td><b>Failed</b></td><td style="color:red;"><b>${{ steps.parse_results.outputs.failed }}</b></td></tr>
            </table>
            <p><a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">View full logs</a></p>
