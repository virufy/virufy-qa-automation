name: Playwright Weekly CI Tests (Email Summary)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 8 * * 1"   # Every Monday 8 AM UTC
  push:

jobs:
  run-playwright:
    runs-on: ubuntu-latest
    container: mcr.microsoft.com/playwright:v1.55.0-jammy

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run Playwright tests
        id: run_tests
        continue-on-error: true
        env:
          BASE_URL: ${{ secrets.BASE_URL }}
        run: |
          # Run tests - HTML reporter is already configured in playwright.config.js
          npx playwright test tests/smoke || true

      - name: Parse HTML report data
        id: parse_results
        run: |
          cat > parse-results.mjs << 'EOF'
          import fs from 'fs';
          import path from 'path';
          
          let passed = 0, failed = 0, total = 0;
          let dataFile = null;
          
          // Playwright HTML report stores data in playwright-report/data.json
          const possiblePaths = [
            'playwright-report/data.json',
            path.join(process.cwd(), 'playwright-report', 'data.json')
          ];
          
          // Also check for alternative locations
          for (const filePath of possiblePaths) {
            if (fs.existsSync(filePath)) {
              dataFile = filePath;
              console.log(`Found HTML report data at: ${filePath}`);
              break;
            }
          }
          
          if (dataFile) {
            try {
              const data = JSON.parse(fs.readFileSync(dataFile, 'utf8'));
              
              // Recursive function to count tests from suites
              function countTests(suite) {
                if (suite.specs && Array.isArray(suite.specs)) {
                  suite.specs.forEach(spec => {
                    if (spec.tests && Array.isArray(spec.tests) && spec.tests.length > 0) {
                      const test = spec.tests[0];
                      if (test.results && Array.isArray(test.results) && test.results.length > 0) {
                        const status = test.results[test.results.length - 1].status;
                        if (status) {
                          total++;
                          if (status === 'passed') passed++;
                          if (status === 'failed') failed++;
                        }
                      }
                    }
                  });
                }
                if (suite.suites && Array.isArray(suite.suites)) {
                  suite.suites.forEach(countTests);
                }
              }
              
              if (data.suites && Array.isArray(data.suites)) {
                data.suites.forEach(countTests);
              }
            } catch (error) {
              console.error(`Error parsing HTML report data: ${error.message}`);
            }
          } else {
            console.log('HTML report data file not found. Checking playwright-report directory...');
            if (fs.existsSync('playwright-report')) {
              const files = fs.readdirSync('playwright-report');
              console.log('Files in playwright-report:', files);
            }
          }
          
          const output = process.env.GITHUB_OUTPUT;
          if (output) {
            fs.appendFileSync(output, `passed=${passed}\n`);
            fs.appendFileSync(output, `failed=${failed}\n`);
            fs.appendFileSync(output, `total=${total}\n`);
          }
          console.log(`Total: ${total}, Passed: ${passed}, Failed: ${failed}`);
          EOF
          
          node parse-results.mjs

      - name: Send summary email
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASS }}
          subject: "Playwright CI Report - ${{ steps.parse_results.outputs.passed }} Passed / ${{ steps.parse_results.outputs.failed }} Failed"
          to: ${{ secrets.REPORT_RECIPIENT }}
          from: "Playwright CI <${{ secrets.SMTP_USER }}>"
          html_body: |
            <h3>Playwright Test Results</h3>
            <table border="1" cellpadding="10" style="border-collapse:collapse;font-family:Arial,sans-serif;">
              <tr style="background:#f0f0f0;">
                <th style="padding:10px;">Metric</th>
                <th style="padding:10px;">Count</th>
              </tr>
              <tr>
                <td style="padding:10px;"><strong>Total Tests</strong></td>
                <td style="padding:10px;">${{ steps.parse_results.outputs.total }}</td>
              </tr>
              <tr style="background:#e8f5e9;">
                <td style="padding:10px;"><strong>Passed</strong></td>
                <td style="padding:10px;color:green;font-weight:bold;">${{ steps.parse_results.outputs.passed }}</td>
              </tr>
              <tr style="background:#ffebee;">
                <td style="padding:10px;"><strong>Failed</strong></td>
                <td style="padding:10px;color:red;font-weight:bold;">${{ steps.parse_results.outputs.failed }}</td>
              </tr>
            </table>
            <br/>
            <p><a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">View Full Run</a></p>
